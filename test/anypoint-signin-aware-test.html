<!doctype html>
<!--
@license
Copyright 2018 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../../@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../../@polymer/test-fixture/test-fixture.js"></script>
    <script src="../../../mocha/mocha.js"></script>
    <script src="../../../chai/chai.js"></script>
    <script src="../../../wct-mocha/wct-mocha.js"></script>
    <script src="../../../sinon/pkg/sinon.js"></script>

    <script src="./auth-server.js"></script>
    <script type="module" src="../anypoint-signin-aware.js"></script>
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <anypoint-signin-aware></anypoint-signin-aware>
      </template>
    </test-fixture>

    <test-fixture id="events">
      <template>
        <anypoint-signin-aware force-oauth-events></anypoint-signin-aware>
      </template>
    </test-fixture>
    <script type="module">
    import {AnypointAuth} from '../anypoint-signin-aware.js';
    /* global AuthServer */
    const clientId = 'test-id';
    const redirectUri = 'test-redirect';
    const replacedMethods = {};
    function replaceAuthMethod(method, fn) {
      const orig = AnypointAuth[method];
      AnypointAuth[method] = fn;
      replacedMethods[method] = orig;
    }
    function restoreMethod(method) {
      AnypointAuth[method] = replacedMethods[method];
      delete replacedMethods[method];
    }
    suite('Basic', function() {
      suiteSetup(function() {
        AuthServer.createServer();
      });

      suiteTeardown(function() {
        AuthServer.restore();
      });

      let element;
      setup(function() {
        element = fixture('basic');
        element.clientId = '';
        element.redirectUri = '';
      });

      test('Auto authorize the user', function() {
        let called = 0;
        const fn = function() {
          called++;
        };
        replaceAuthMethod('_initSignIn', fn);
        element.clientId = clientId;
        element.redirectUri = redirectUri;
        restoreMethod('_initSignIn');
        assert.equal(called, 2);
      });

      test('Auto calls signin function', function() {
        let called = false;
        let argValue;
        const fn = function(arg) {
          called = true;
          argValue = arg;
        };
        replaceAuthMethod('signIn', fn);
        element.clientId = clientId;
        element.redirectUri = redirectUri;
        restoreMethod('signIn');
        assert.isTrue(called);
        assert.isFalse(argValue);
      });

      test('signIn() calls oauth factory', function() {
        let called = false;
        let argValue;
        const factory = {
          authorize: function(arg) {
            called = true;
            argValue = arg;
          }
        };
        replaceAuthMethod('_oauthFactory', factory);
        element.clientId = clientId;
        element.redirectUri = redirectUri;
        restoreMethod('_oauthFactory');
        assert.isTrue(called);
        assert.equal(argValue.type, 'implicit');
        assert.equal(argValue.authorizationUri, 'https://anypoint.mulesoft.com/accounts/oauth2/authorize');
        assert.equal(argValue.clientId, clientId);
        assert.equal(argValue.redirectUri, redirectUri);
        assert.typeOf(argValue.state, 'string');
      });

      test('Sets properties when the response is ready', function(done) {
        let argValue;
        const factory = {
          authorize: function(arg) {
            argValue = arg;
          }
        };
        replaceAuthMethod('_oauthFactory', factory);
        element.clientId = clientId;
        element.redirectUri = redirectUri;
        restoreMethod('_oauthFactory');
        element.addEventListener('anypoint-signin-aware-success', function clb(e) {
          element.removeEventListener('anypoint-signin-aware-success', clb);
          assert.isTrue(element.signedIn);
          assert.equal(element.accessToken, 'test-token');
          assert.typeOf(element.user, 'object');
          assert.equal(element.user.username, 'test-user');
          assert.typeOf(e.detail, 'object');
          assert.equal(e.detail.username, 'test-user');
          done();
        });
        const oauth = document.body.querySelector('oauth2-authorization');
        oauth.dispatchEvent(new CustomEvent('oauth2-token-response', {
          bubbles: true,
          composed: true,
          detail: {
            accessToken: 'test-token',
            state: argValue.state
          }
        }));
      });

      test('Signs out the user', function(done) {
        let argValue;
        const factory = {
          authorize: function(arg) {
            argValue = arg;
          }
        };
        replaceAuthMethod('_oauthFactory', factory);
        element.clientId = clientId;
        element.redirectUri = redirectUri;
        restoreMethod('_oauthFactory');
        element.addEventListener('anypoint-signin-aware-success', function clb() {
          element.removeEventListener('anypoint-signin-aware-success', clb);
          element.signOut();
        });
        element.addEventListener('anypoint-signin-aware-signed-out', function clb() {
          element.removeEventListener('anypoint-signin-aware-signed-out', clb);
          assert.isUndefined(element.accessToken);
          assert.isUndefined(element.user);
          assert.isFalse(element.signedIn);
          done();
        });
        const oauth = document.body.querySelector('oauth2-authorization');
        oauth.dispatchEvent(new CustomEvent('oauth2-token-response', {
          bubbles: true,
          composed: true,
          detail: {
            accessToken: 'test-token',
            state: argValue.state
          }
        }));
      });
    });

    suite('force-oauth-events', function() {
      let element;
      setup(function() {
        element = fixture('events');
      });

      test('Dispatches oauth2-token-requested custom event', function() {
        const spy = sinon.spy();
        document.body.addEventListener('oauth2-token-requested', spy);
        element.clientId = clientId;
        element.redirectUri = redirectUri;
        element.signIn();
        assert.isTrue(spy.calledOnce);
      });
    });

    suite('AnypointAuth', () => {
      suite('_oauth2ErrorHandler()', () => {
        let element;
        setup(function() {
          element = fixture('basic');
          AnypointAuth.accessToken = 'test-token';
          AnypointAuth.user = {user: 'test-user'};
          AnypointAuth.signedIn = true;
          AnypointAuth._lastState = 'abcd';
        });

        test('Clears token data', () => {
          AnypointAuth._oauth2ErrorHandler({
            detail: {
              state: 'abcd'
            }
          });
          assert.equal(AnypointAuth.accessToken, null);
          assert.equal(AnypointAuth.user, null);
          assert.isFalse(AnypointAuth.signedIn);
        });

        test('Passes error message to the aware', () => {
          const spy = sinon.spy(element, 'errorNotify');
          AnypointAuth._oauth2ErrorHandler({
            detail: {
              state: 'abcd',
              message: 'test-message'
            }
          });
          assert.isTrue(spy.called);
          assert.equal(spy.args[0][0].message, 'test-message');
        });

        test('Won\t report error when non-interactive', () => {
          const spy = sinon.spy(element, 'errorNotify');
          AnypointAuth._oauth2ErrorHandler({
            detail: {
              state: 'abcd',
              message: 'test-message',
              interactive: false
            }
          });
          assert.isFalse(spy.called);
        });

        test('Calls _updateStatus() on aware', () => {
          const spy = sinon.spy(element, '_updateStatus');
          AnypointAuth._oauth2ErrorHandler({
            detail: {
              state: 'abcd'
            }
          });
          assert.isTrue(spy.called);
          assert.isUndefined(spy.args[0][0]);
        });

        test('Does nothing when state is different', () => {
          const spy = sinon.spy(element, '_updateStatus');
          AnypointAuth._oauth2ErrorHandler({
            detail: {
              state: 'other'
            }
          });
          assert.isFalse(spy.called);
        });
      });

      suite('_oauth2TokenHandler()', () => {
        suiteSetup(function() {
          AuthServer.createServer();
        });

        suiteTeardown(function() {
          AuthServer.restore();
        });

        let element;
        setup(function() {
          element = fixture('basic');
          AnypointAuth.accessToken = null;
          AnypointAuth.user = null;
          AnypointAuth.signedIn = false;
          AnypointAuth._lastState = 'abcd';
        });

        teardown(() => {
          if (AnypointAuth._getProfile.restore) {
            AnypointAuth._getProfile.restore();
          }
        });

        test('Does nothing when no detail on event', () => {
          const spy = sinon.spy(AnypointAuth, '_getProfile');
          AnypointAuth._oauth2TokenHandler({});
          assert.isFalse(spy.called);
        });

        test('Does nothing when different state', () => {
          const spy = sinon.spy(AnypointAuth, '_getProfile');
          AnypointAuth._oauth2TokenHandler({
            detail: {
              state: 'other'
            }
          });
          assert.isFalse(spy.called);
        });

        test('Calles setAuthData() only when no access token', () => {
          const spy = sinon.spy(AnypointAuth, '_getProfile');
          const spy2 = sinon.spy(AnypointAuth, 'setAuthData');
          AnypointAuth._oauth2TokenHandler({
            detail: {
              state: 'abcd'
            }
          });
          AnypointAuth.setAuthData.restore();
          assert.isFalse(spy.called);
          assert.isTrue(spy2.called);
          assert.isUndefined(spy2.args[0][0]);
        });

        test('Calls _getProfile()', () => {
          return AnypointAuth._oauth2TokenHandler({
            detail: {
              state: 'abcd',
              accessToken: 'test'
            }
          })
          .then(() => {
            assert.deepEqual(AnypointAuth.user, {username: 'test-user'});
          });
        });

        test('Sets token only when profile get was error', () => {
          return AnypointAuth._oauth2TokenHandler({
            detail: {
              state: 'abcd',
              accessToken: 'no-token'
            }
          })
          .then(() => {
            assert.equal(AnypointAuth.user, null);
            assert.equal(AnypointAuth.accessToken, 'no-token');
          });
        });
      });

      suite('_getProfile()', () => {
        suiteSetup(function() {
          AuthServer.createServer();
        });

        suiteTeardown(function() {
          AuthServer.restore();
        });

        let element;
        setup(function() {
          element = fixture('basic');
          AnypointAuth.accessToken = null;
          AnypointAuth.user = null;
          AnypointAuth.signedIn = false;
        });

        test('Calls setAuthData()', () => {
          const spy = sinon.spy(AnypointAuth, 'setAuthData');
          return AnypointAuth._getProfile('token-123')
          .then(() => {
            AnypointAuth.setAuthData.restore();
            assert.isTrue(spy.called);
            assert.equal(spy.args[0][0], 'token-123');
            assert.deepEqual(spy.args[0][1], {username: 'test-user'});
          });
        });

        test('Sets profile data', () => {
          return AnypointAuth._getProfile('token-123')
          .then(() => {
            assert.isTrue(AnypointAuth.signedIn);
            assert.deepEqual(AnypointAuth.user, {username: 'test-user'});
          });
        });

        test('Updates status of the aware', () => {
          const spy = sinon.spy(element, '_updateStatus');
          return AnypointAuth._getProfile('token-123')
          .then(() => {
            assert.isTrue(spy.called);
          });
        });

        test('Uses token set on auth factory', () => {
          AnypointAuth.accessToken = 'token-123';
          return AnypointAuth._getProfile()
          .then(() => {
            assert.deepEqual(AnypointAuth.user, {username: 'test-user'});
          });
        });

        test('Rejects when request error', () => {
          return AnypointAuth._getProfile('no-token')
          .then(() => {
            throw new Error('Should not resolve.');
          })
          .catch((cause) => {
            assert.notEqual(cause.message, 'Should not resolve.');
          });
        });

        test('Returns 401 status message', () => {
          return AnypointAuth._getProfile('no-token')
          .catch((cause) => {
            assert.equal(cause.message, 'Invalid access token. Server status is 401.');
          });
        });

        test('Returns 404 status message', () => {
          return AnypointAuth._getProfile('invalid-profile')
          .catch((cause) => {
            assert.equal(cause.message, 'Profile URL is invalid.');
          });
        });

        test('Returns 4xx status message', () => {
          return AnypointAuth._getProfile('error-400')
          .catch((cause) => {
            assert.equal(cause.message, 'Server do not support this method. Response code is 400.');
          });
        });

        test('Returns 5xx status message', () => {
          return AnypointAuth._getProfile('error-500')
          .catch((cause) => {
            assert.equal(cause.message, 'Authorization server error. Response code is  500.');
          });
        });
      });

      suite('notifyError()', () => {
        let element;
        setup(function() {
          element = fixture('basic');
        });

        test('Calls errorNotify() on the aware', () => {
          const spy = sinon.spy(element, 'errorNotify');
          AnypointAuth.notifyError('test-message');
          assert.isTrue(spy.called);
        });
      });

      suite('assertAuthInitialized()', () => {
        let element;
        setup(function() {
          element = fixture('basic');
        });

        test('Throws when no clientId', () => {
          element.clientId = '';
          element.redirectUri = '';
          assert.throws(() => {
            AnypointAuth.assertAuthInitialized();
          }, 'AuthEngine not initialized. clientId has not been configured.');
        });

        test('Throws when no redirectUri', () => {
          element.clientId = 'testid';
          element.redirectUri = '';
          assert.throws(() => {
            AnypointAuth.assertAuthInitialized();
          }, 'AuthEngine not initialized. redirectUri has not been configured.');
        });

        test('Passes when data is set', () => {
          element.clientId = 'testid';
          element.redirectUri = 'test-uri';
        });
      });
    });
    </script>

  </body>
</html>
